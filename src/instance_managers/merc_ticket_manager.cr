module MercTicketManager
  extend self
  extend Loggable

  private DROPPED_TICKETS = Array(L2ItemInstance).new

  private MAX_MERC_PER_TYPE = Int32.slice(
    10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, # Gludio
    15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, # Dion
    10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, # Giran
    10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, # Oren
    20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, # Aden
    20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, # Innadril
    20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, # Goddard
    20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, # Rune
    20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20  # Schuttgart
  )

  MERCS_MAX_PER_CASTLE = Int32.slice(
    100, # Gludio
    150, # Dion
    200, # Giran
    300, # Oren
    400, # Aden
    400, # Innadril
    400, # Goddard
    400, # Rune
    400  # Schuttgart
  )

  private ITEM_IDS = Int32.slice(
    3960, 3961, 3962, 3963, 3964, 3965, 3966, 3967, 3968, 3969, 6115, 6116, 6117, 6118, 6119, 6120, 6121, 6122, 6123, 6124, 6038, 6039, 6040, 6041, 6042, 6043, 6044, 6045, 6046, 6047, 6175, 6176, 6177, 6178, 6179, 6180, 6181, 6182, 6183, 6184, 6235, 6236, 6237, 6238, 6239, 6240, 6241, 6242, 6243, 6244, 6295, 6296, # Gludio
    3973, 3974, 3975, 3976, 3977, 3978, 3979, 3980, 3981, 3982, 6125, 6126, 6127, 6128, 6129, 6130, 6131, 6132, 6133, 6134, 6051, 6052, 6053, 6054, 6055, 6056, 6057, 6058, 6059, 6060, 6185, 6186, 6187, 6188, 6189, 6190, 6191, 6192, 6193, 6194, 6245, 6246, 6247, 6248, 6249, 6250, 6251, 6252, 6253, 6254, 6297, 6298, # Dion
    3986, 3987, 3988, 3989, 3990, 3991, 3992, 3993, 3994, 3995, 6135, 6136, 6137, 6138, 6139, 6140, 6141, 6142, 6143, 6144, 6064, 6065, 6066, 6067, 6068, 6069, 6070, 6071, 6072, 6073, 6195, 6196, 6197, 6198, 6199, 6200, 6201, 6202, 6203, 6204, 6255, 6256, 6257, 6258, 6259, 6260, 6261, 6262, 6263, 6264, 6299, 6300, # Giran
    3999, 4000, 4001, 4002, 4003, 4004, 4005, 4006, 4007, 4008, 6145, 6146, 6147, 6148, 6149, 6150, 6151, 6152, 6153, 6154, 6077, 6078, 6079, 6080, 6081, 6082, 6083, 6084, 6085, 6086, 6205, 6206, 6207, 6208, 6209, 6210, 6211, 6212, 6213, 6214, 6265, 6266, 6267, 6268, 6269, 6270, 6271, 6272, 6273, 6274, 6301, 6302, # Oren
    4012, 4013, 4014, 4015, 4016, 4017, 4018, 4019, 4020, 4021, 6155, 6156, 6157, 6158, 6159, 6160, 6161, 6162, 6163, 6164, 6090, 6091, 6092, 6093, 6094, 6095, 6096, 6097, 6098, 6099, 6215, 6216, 6217, 6218, 6219, 6220, 6221, 6222, 6223, 6224, 6275, 6276, 6277, 6278, 6279, 6280, 6281, 6282, 6283, 6284, 6303, 6304, # Aden
    5205, 5206, 5207, 5208, 5209, 5210, 5211, 5212, 5213, 5214, 6165, 6166, 6167, 6168, 6169, 6170, 6171, 6172, 6173, 6174, 6105, 6106, 6107, 6108, 6109, 6110, 6111, 6112, 6113, 6114, 6225, 6226, 6227, 6228, 6229, 6230, 6231, 6232, 6233, 6234, 6285, 6286, 6287, 6288, 6289, 6290, 6291, 6292, 6293, 6294, 6305, 6306, # Innadril
    6779, 6780, 6781, 6782, 6783, 6784, 6785, 6786, 6787, 6788, 6802, 6803, 6804, 6805, 6806, 6807, 6808, 6809, 6810, 6811, 6792, 6793, 6794, 6795, 6796, 6797, 6798, 6799, 6800, 6801, 6812, 6813, 6814, 6815, 6816, 6817, 6818, 6819, 6820, 6821, 6822, 6823, 6824, 6825, 6826, 6827, 6828, 6829, 6830, 6831, 6832, 6833, # Goddard
    7973, 7974, 7975, 7976, 7977, 7978, 7979, 7980, 7981, 7982, 7998, 7999, 8000, 8001, 8002, 8003, 8004, 8005, 8006, 8007, 7988, 7989, 7990, 7991, 7992, 7993, 7994, 7995, 7996, 7997, 8008, 8009, 8010, 8011, 8012, 8013, 8014, 8015, 8016, 8017, 8018, 8019, 8020, 8021, 8022, 8023, 8024, 8025, 8026, 8027, 8028, 8029, # Rune
    7918, 7919, 7920, 7921, 7922, 7923, 7924, 7925, 7926, 7927, 7941, 7942, 7943, 7944, 7945, 7946, 7947, 7948, 7949, 7950, 7931, 7932, 7933, 7934, 7935, 7936, 7937, 7938, 7939, 7940, 7951, 7952, 7953, 7954, 7955, 7956, 7957, 7958, 7959, 7960, 7961, 7962, 7963, 7964, 7965, 7966, 7967, 7968, 7969, 7970, 7971, 7972  # Schuttgart
  )

  private NPC_IDS = Int32.slice(
    35010, 35011, 35012, 35013, 35014, 35015, 35016, 35017, 35018, 35019, 35020, 35021, 35022, 35023, 35024, 35025, 35026, 35027, 35028, 35029, 35030,35031,35032,35033,35034,35035,35036,35037,35038,35039, 35040, 35041, 35042, 35043, 35044, 35045, 35046, 35047, 35048, 35049, 35050, 35051, 35052, 35053, 35054, 35055, 35056, 35057, 35058, 35059, 35060, 35061, # Gludio
    35010, 35011, 35012, 35013, 35014, 35015, 35016, 35017, 35018, 35019, 35020, 35021, 35022, 35023, 35024, 35025, 35026, 35027, 35028, 35029, 35030,35031,35032,35033,35034,35035,35036,35037,35038,35039, 35040, 35041, 35042, 35043, 35044, 35045, 35046, 35047, 35048, 35049, 35050, 35051, 35052, 35053, 35054, 35055, 35056, 35057, 35058, 35059, 35060, 35061, # Dion
    35010, 35011, 35012, 35013, 35014, 35015, 35016, 35017, 35018, 35019, 35020, 35021, 35022, 35023, 35024, 35025, 35026, 35027, 35028, 35029, 35030,35031,35032,35033,35034,35035,35036,35037,35038,35039, 35040, 35041, 35042, 35043, 35044, 35045, 35046, 35047, 35048, 35049, 35050, 35051, 35052, 35053, 35054, 35055, 35056, 35057, 35058, 35059, 35060, 35061, # Giran
    35010, 35011, 35012, 35013, 35014, 35015, 35016, 35017, 35018, 35019, 35020, 35021, 35022, 35023, 35024, 35025, 35026, 35027, 35028, 35029, 35030,35031,35032,35033,35034,35035,35036,35037,35038,35039, 35040, 35041, 35042, 35043, 35044, 35045, 35046, 35047, 35048, 35049, 35050, 35051, 35052, 35053, 35054, 35055, 35056, 35057, 35058, 35059, 35060, 35061, # Oren
    35010, 35011, 35012, 35013, 35014, 35015, 35016, 35017, 35018, 35019, 35020, 35021, 35022, 35023, 35024, 35025, 35026, 35027, 35028, 35029, 35030,35031,35032,35033,35034,35035,35036,35037,35038,35039, 35040, 35041, 35042, 35043, 35044, 35045, 35046, 35047, 35048, 35049, 35050, 35051, 35052, 35053, 35054, 35055, 35056, 35057, 35058, 35059, 35060, 35061, # Aden
    35010, 35011, 35012, 35013, 35014, 35015, 35016, 35017, 35018, 35019, 35020, 35021, 35022, 35023, 35024, 35025, 35026, 35027, 35028, 35029, 35030,35031,35032,35033,35034,35035,35036,35037,35038,35039, 35040, 35041, 35042, 35043, 35044, 35045, 35046, 35047, 35048, 35049, 35050, 35051, 35052, 35053, 35054, 35055, 35056, 35057, 35058, 35059, 35060, 35061, # Innadril
    35010, 35011, 35012, 35013, 35014, 35015, 35016, 35017, 35018, 35019, 35020, 35021, 35022, 35023, 35024, 35025, 35026, 35027, 35028, 35029, 35030,35031,35032,35033,35034,35035,35036,35037,35038,35039, 35040, 35041, 35042, 35043, 35044, 35045, 35046, 35047, 35048, 35049, 35050, 35051, 35052, 35053, 35054, 35055, 35056, 35057, 35058, 35059, 35060, 35061, # Goddard
    35010, 35011, 35012, 35013, 35014, 35015, 35016, 35017, 35018, 35019, 35020, 35021, 35022, 35023, 35024, 35025, 35026, 35027, 35028, 35029, 35030,35031,35032,35033,35034,35035,35036,35037,35038,35039, 35040, 35041, 35042, 35043, 35044, 35045, 35046, 35047, 35048, 35049, 35050, 35051, 35052, 35053, 35054, 35055, 35056, 35057, 35058, 35059, 35060, 35061, # Rune
    35010, 35011, 35012, 35013, 35014, 35015, 35016, 35017, 35018, 35019, 35020, 35021, 35022, 35023, 35024, 35025, 35026, 35027, 35028, 35029, 35030,35031,35032,35033,35034,35035,35036,35037,35038,35039, 35040, 35041, 35042, 35043, 35044, 35045, 35046, 35047, 35048, 35049, 35050, 35051, 35052, 35053, 35054, 35055, 35056, 35057, 35058, 35059, 35060, 35061  # Schuttgart
  )

  private GUARDIAN_TYPES_COUNT = 52

  def load
    timer = Timer.new
    merc_placed = Slice(Int32).new(20)
    start_index = 0
    sql = "SELECT * FROM castle_siege_guards Where isHired = 1"
    GameDB.each(sql) do |rs|
      npc_id = rs.get_i32("npcId")
      x = rs.get_i32("x")
      y = rs.get_i32("y")
      z = rs.get_i32("z")
      if castle = CastleManager.get_castle(x, y, z)
        if merc_placed[castle.residence_id - 1] >= MERCS_MAX_PER_CASTLE[castle.residence_id - 1]
          next
        end
        start_index = GUARDIAN_TYPES_COUNT * (castle.residence_id - 1)
        merc_placed[castle.residence_id - 1] += 1
      end

      start_index.upto(start_index + GUARDIAN_TYPES_COUNT - 1) do |i|
        if NPC_IDS[i] == npc_id
          if castle && !castle.siege.in_progress?
            item_id = ITEM_IDS[i]
            drop_ticket = L2ItemInstance.new(IdFactory.next, item_id)
            drop_ticket.item_location = ItemLocation::VOID
            drop_ticket.drop_me(nil, x, y, z)
            drop_ticket.drop_time = 0
            L2World.store_object(drop_ticket)
            DROPPED_TICKETS << drop_ticket
          end
          break
        end
      end
    end

    info "Loaded #{DROPPED_TICKETS.size} Mercenary Tickets in #{timer} s."
  rescue e
    error e
  end

  def get_ticket_castle_id(item_id : Int32) : Int32
    9.times do |i|
      i2 = 0
      while i2 < 50
        if item_id >= ITEM_IDS[i2 + (i * GUARDIAN_TYPES_COUNT)] && item_id <= ITEM_IDS[i2 + 9 + (i * GUARDIAN_TYPES_COUNT)]
          return i + 1
        end
        i2 += 10
      end

      if item_id >= ITEM_IDS[50] && item_id <= ITEM_IDS[51]
        return i + 1
      end
    end

    -1
  end

  def at_type_limit?(item_id : Int32) : Bool
    limit = -1
    ITEM_IDS.each_with_index do |temp, i|
      if temp == item_id
        limit = MAX_MERC_PER_TYPE[i]
        break
      end
    end

    if limit <= 0
      return true
    end

    count = DROPPED_TICKETS.count { |ticket| ticket.id == item_id }
    count >= limit
  end

  def at_castle_limit?(item_id : Int32) : Bool
    castle_id = get_ticket_castle_id(item_id)
    if castle_id <= 0
      return true
    end

    limit = MERCS_MAX_PER_CASTLE[castle_id - 1]
    if limit <= 0
      return true
    end

    count = DROPPED_TICKETS.count do |ticket|
      get_ticket_castle_id(ticket.id) == castle_id
    end

    count >= limit
  end

  def get_max_allowed_merc(castle_id : Int32) : Int32
    MERCS_MAX_PER_CASTLE[castle_id - 1]
  end

  def too_close_to_another_ticket?(x : Int32, y : Int32, z : Int32) : Bool
    DROPPED_TICKETS.any? do |ticket|
      dx = x - ticket.x
      dy = y - ticket.y
      dz = z - ticket.z

      dx.abs2 + dy.abs2 + dz.abs2 < 25.abs2
    end
  end

  def add_ticket(item_id : Int32, pc : L2PcInstance) : Int32
    x, y, z = pc.xyz
    heading = pc.heading

    unless castle = CastleManager.get_castle(pc)
      return -1
    end

    ITEM_IDS.zip(NPC_IDS) do |iid, npc_id|
      if iid == item_id
        spawn_mercenary(npc_id, x, y, z, 3000)

        castle.siege.siege_guard_manager.hire_merc(x, y, z, heading, npc_id)

        drop_ticket = L2ItemInstance.new(IdFactory.next, item_id)
        drop_ticket.item_location = ItemLocation::VOID
        drop_ticket.drop_me(nil, x, y, z)
        drop_ticket.drop_time = 0
        L2World.store_object(drop_ticket)
        DROPPED_TICKETS << drop_ticket

        return npc_id
      end
    end

    -1
  end

  private def spawn_mercenary(npc_id : Int32, x : Int32, y : Int32, z : Int32, despawn_delay : Int)
    if template = NpcData[npc_id]?
      npc = L2DefenderInstance.new(template)
      npc.heal!
      npc.decayed = false
      npc.spawn_me(x, y, z + 20)
      if despawn_delay > 0
        npc.schedule_despawn(despawn_delay.to_i64)
      end
    end
  end

  def delete_tickets(castle_id : Int32)
    DROPPED_TICKETS.reject! do |ticket|
      if get_ticket_castle_id(ticket.id) == castle_id
        ticket.decay_me
        L2World.remove_object(ticket)
        true
      end
    end
  end

  def remove_ticket(item : L2ItemInstance)
    item_id = item.id
    npc_id = -1

    ITEM_IDS.zip(NPC_IDS) do |iid, nid|
      if nid == item_id
        npc_id = nid
        break
      end
    end

    castle = CastleManager.get_castle_by_id(get_ticket_castle_id(item_id))
    if npc_id > 0 && castle
      SiegeGuardManager.new(castle).remove_merc(npc_id, *item.xyz)
    end

    DROPPED_TICKETS.delete(item)
  end

  def item_ids
    ITEM_IDS
  end

  def dropped_tickets
    DROPPED_TICKETS
  end
end
